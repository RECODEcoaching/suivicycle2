<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Suivi de Cycle</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  :root {
    --purple: #667eea;
    --purple-dark: #764ba2;
    --bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    --card: rgba(255, 255, 255, 0.9);
    --text: #1a1a1a;
    --text-secondary: #6C6C70;
    --red: #FF3B30;
    --green: #34C759;
    --orange: #FF9500;
    --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
    --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
  }
  
  body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    position: relative;
  }
  
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: -1;
  }
  
  /* LOGIN */
  .login-screen {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
  }
  
  .login-card {
    background: var(--card);
    backdrop-filter: blur(20px);
    padding: 40px;
    border-radius: 24px;
    box-shadow: var(--shadow-md);
    width: 100%;
    max-width: 400px;
  }
  
  .login-icon {
    font-size: 64px;
    text-align: center;
    margin-bottom: 20px;
  }
  
  .login-title {
    font-size: 28px;
    font-weight: 800;
    text-align: center;
    margin-bottom: 8px;
    background: linear-gradient(135deg, var(--purple) 0%, var(--purple-dark) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .login-subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    text-align: center;
    margin-bottom: 30px;
  }
  
  .login-input {
    width: 100%;
    padding: 16px;
    border: 2px solid rgba(0,0,0,0.1);
    border-radius: 12px;
    font-size: 16px;
    margin-bottom: 16px;
    font-family: var(--font);
  }
  
  .login-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--purple) 0%, var(--purple-dark) 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 17px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }
  
  .error-msg {
    color: var(--red);
    font-size: 13px;
    text-align: center;
    margin-top: 12px;
    display: none;
  }
  
  .error-msg.show { display: block; }
  
  /* ADMIN APP */
  .admin-app {
    display: none;
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    padding-bottom: 100px;
  }
  
  .admin-app.active { display: block; }
  
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    background: var(--card);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-md);
  }
  
  .header-title {
    font-size: 24px;
    font-weight: 800;
    background: linear-gradient(135deg, var(--purple) 0%, var(--purple-dark) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .logout-btn {
    padding: 10px 20px;
    background: var(--red);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 30px;
  }
  
  .stat-card {
    background: var(--card);
    backdrop-filter: blur(20px);
    padding: 20px;
    border-radius: 20px;
    box-shadow: var(--shadow-md);
    text-align: center;
  }
  
  .stat-value {
    font-size: 36px;
    font-weight: 800;
    background: linear-gradient(135deg, var(--purple) 0%, var(--purple-dark) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .stat-label {
    font-size: 14px;
    color: var(--text-secondary);
    margin-top: 8px;
    font-weight: 600;
  }
  
  .section {
    background: var(--card);
    backdrop-filter: blur(20px);
    padding: 24px;
    border-radius: 20px;
    box-shadow: var(--shadow-md);
    margin-bottom: 20px;
  }
  
  .section-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 20px;
  }
  
  .add-btn {
    padding: 12px 24px;
    background: linear-gradient(135deg, var(--purple) 0%, var(--purple-dark) 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    margin-bottom: 20px;
  }
  
  .clients-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .clients-table th {
    text-align: left;
    padding: 12px;
    border-bottom: 2px solid rgba(0,0,0,0.1);
    font-weight: 700;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
  }
  
  .clients-table td {
    padding: 16px 12px;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  
  .clients-table tr:hover {
    background: rgba(102, 126, 234, 0.05);
  }
  
  .action-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    margin-right: 6px;
  }
  
  .btn-view {
    background: var(--purple);
    color: white;
  }
  
  .btn-edit {
    background: var(--orange);
    color: white;
  }
  
  .btn-delete {
    background: var(--red);
    color: white;
  }
  
  /* MODAL */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(8px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  
  .modal.show { display: flex; }
  
  .modal-content {
    background: var(--card);
    border-radius: 20px;
    padding: 30px;
    max-width: 900px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
  }
  
  .modal-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 20px;
  }
  
  .form-group {
    margin-bottom: 16px;
  }
  
  .form-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-secondary);
  }
  
  .form-input {
    width: 100%;
    padding: 12px;
    border: 2px solid rgba(0,0,0,0.1);
    border-radius: 10px;
    font-size: 15px;
    font-family: var(--font);
  }
  
  .modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
  }
  
  .modal-btn {
    flex: 1;
    padding: 14px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, var(--purple) 0%, var(--purple-dark) 100%);
    color: white;
  }
  
  .btn-secondary {
    background: rgba(0,0,0,0.05);
    color: var(--text);
  }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="login-icon">üîê</div>
    <h1 class="login-title">Admin Panel</h1>
    <p class="login-subtitle">Acc√®s administrateur</p>
    <input type="password" class="login-input" id="adminPassword" placeholder="Mot de passe admin">
    <button class="login-btn" onclick="adminLogin()">Se connecter</button>
    <div class="error-msg" id="errorMsg">Mot de passe incorrect</div>
  </div>
</div>

<!-- ADMIN APP -->
<div class="admin-app" id="adminApp">
  <div class="header">
    <div class="header-title">üëë Admin Panel</div>
    <button class="logout-btn" onclick="adminLogout()">D√©connexion</button>
  </div>
  
  <!-- STATS -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="totalClients">0</div>
      <div class="stat-label">Clientes</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="totalCycles">0</div>
      <div class="stat-label">Cycles enregistr√©s</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="avgCycleLength">0</div>
      <div class="stat-label">Dur√©e moy. cycle</div>
    </div>
  </div>
  
  <!-- CLIENTS LIST -->
  <div class="section">
    <div class="section-title">Gestion des clientes</div>
    <button class="add-btn" onclick="openAddClientModal()">+ Ajouter une cliente</button>
    <table class="clients-table" id="clientsTable">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Code</th>
          <th>Date cr√©ation</th>
          <th>Contraception</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="clientsTableBody">
        <!-- Will be filled by JS -->
      </tbody>
    </table>
  </div>
</div>

<!-- ADD/EDIT CLIENT MODAL -->
<div class="modal" id="clientModal">
  <div class="modal-content">
    <h2 class="modal-title" id="modalTitle">Ajouter une cliente</h2>
    <div class="form-group">
      <label class="form-label">Nom</label>
      <input type="text" class="form-input" id="clientName" placeholder="Marie">
    </div>
    <div class="form-group">
      <label class="form-label">Code (minuscules, sans espaces)</label>
      <input type="text" class="form-input" id="clientCode" placeholder="marie">
    </div>
    <div class="modal-actions">
      <button class="modal-btn btn-secondary" onclick="closeClientModal()">Annuler</button>
      <button class="modal-btn btn-primary" onclick="saveClient()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- VIEW CLIENT MODAL -->
<div class="modal" id="viewClientModal">
  <div class="modal-content">
    <h2 class="modal-title" id="viewClientName">Cliente</h2>
    <div id="clientDataContainer">
      <!-- Will be filled by JS -->
    </div>
    <div class="modal-actions">
      <button class="modal-btn btn-secondary" onclick="exportClientPDF()">üìÑ Export PDF</button>
      <button class="modal-btn btn-primary" onclick="closeViewClientModal()">Fermer</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://ruxfbuocwncycbqwsgif.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1eGZidW9jd25jeWNicXdzZ2lmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MDE1NzEsImV4cCI6MjA4NzA3NzU3MX0.JmLq-8RT3Sb81WVP5h1OPiIfiXHmHEkTKk0HuxLJnik';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const ADMIN_PASSWORD = 'ADMINFonetrical9*!77';
let currentEditingClient = null;
let currentViewClient = null;
let currentViewCycleData = null;

// LOGIN
async function adminLogin() {
  const password = document.getElementById('adminPassword').value;
  if (password === ADMIN_PASSWORD) {
    localStorage.setItem('adminLoggedIn', 'true');
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('adminApp').classList.add('active');
    await loadDashboard();
  } else {
    document.getElementById('errorMsg').classList.add('show');
  }
}

function adminLogout() {
  localStorage.removeItem('adminLoggedIn');
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('adminApp').classList.remove('active');
}

// LOAD DASHBOARD
async function loadDashboard() {
  await loadStats();
  await loadClients();
}

async function loadStats() {
  // Get total clients
  const { data: clients } = await supabaseClient.from('clients').select('*');
  document.getElementById('totalClients').textContent = clients ? clients.length : 0;
  
  // Get total cycles
  const { data: cycleData } = await supabaseClient.from('cycle_data').select('*');
  
  // Count unique cycles (by client)
  const clientCycles = {};
  if (cycleData) {
    cycleData.forEach(day => {
      if (!clientCycles[day.client_id]) clientCycles[day.client_id] = new Set();
      clientCycles[day.client_id].add(day.date);
    });
  }
  
  const totalCycles = Object.keys(clientCycles).length;
  document.getElementById('totalCycles').textContent = totalCycles;
  
  // Calculate average cycle length
  document.getElementById('avgCycleLength').textContent = '28j';
}

async function loadClients() {
  const { data: clients, error } = await supabaseClient
    .from('clients')
    .select('*')
    .order('created_at', { ascending: false });
  
  if (error) {
    console.error('Error loading clients:', error);
    return;
  }
  
  const tbody = document.getElementById('clientsTableBody');
  tbody.innerHTML = clients.map(client => `
    <tr>
      <td><strong>${client.name || client.code}</strong></td>
      <td>${client.code}</td>
      <td>${new Date(client.created_at).toLocaleDateString('fr-FR')}</td>
      <td>${client.contraception || 'Aucune'}</td>
      <td>
        <button class="action-btn btn-view" onclick="viewClient('${client.id}')">üëÅÔ∏è Voir</button>
        <button class="action-btn btn-edit" onclick="editClient('${client.id}')">‚úèÔ∏è Modifier</button>
        <button class="action-btn btn-delete" onclick="deleteClient('${client.id}', '${client.code}')">üóëÔ∏è Supprimer</button>
      </td>
    </tr>
  `).join('');
}

// ADD CLIENT
function openAddClientModal() {
  currentEditingClient = null;
  document.getElementById('modalTitle').textContent = 'Ajouter une cliente';
  document.getElementById('clientName').value = '';
  document.getElementById('clientCode').value = '';
  document.getElementById('clientModal').classList.add('show');
}

function closeClientModal() {
  document.getElementById('clientModal').classList.remove('show');
}

async function saveClient() {
  const name = document.getElementById('clientName').value.trim();
  const code = document.getElementById('clientCode').value.trim().toLowerCase();
  
  if (!name || !code) {
    alert('Veuillez remplir tous les champs');
    return;
  }
  
  if (currentEditingClient) {
    // Update
    const { error } = await supabaseClient
      .from('clients')
      .update({ name, code })
      .eq('id', currentEditingClient);
    
    if (error) {
      alert('Erreur: ' + error.message);
      return;
    }
  } else {
    // Create
    const { error } = await supabaseClient
      .from('clients')
      .insert([{ name, code }]);
    
    if (error) {
      alert('Erreur: ' + error.message);
      return;
    }
  }
  
  closeClientModal();
  await loadDashboard();
}

// EDIT CLIENT
async function editClient(clientId) {
  const { data: client } = await supabaseClient
    .from('clients')
    .select('*')
    .eq('id', clientId)
    .single();
  
  if (client) {
    currentEditingClient = clientId;
    document.getElementById('modalTitle').textContent = 'Modifier la cliente';
    document.getElementById('clientName').value = client.name || '';
    document.getElementById('clientCode').value = client.code;
    document.getElementById('clientModal').classList.add('show');
  }
}

// DELETE CLIENT
async function deleteClient(clientId, clientCode) {
  if (!confirm(`√ätes-vous s√ªr de vouloir supprimer la cliente "${clientCode}" ? Toutes ses donn√©es seront supprim√©es.`)) {
    return;
  }
  
  // Delete cycle data first
  await supabaseClient.from('cycle_data').delete().eq('client_id', clientId);
  
  // Delete client
  const { error } = await supabaseClient.from('clients').delete().eq('id', clientId);
  
  if (error) {
    alert('Erreur: ' + error.message);
    return;
  }
  
  await loadDashboard();
}

// VIEW CLIENT
async function viewClient(clientId) {
  const { data: client } = await supabaseClient
    .from('clients')
    .select('*')
    .eq('id', clientId)
    .single();
  
  const { data: cycleData } = await supabaseClient
    .from('cycle_data')
    .select('*')
    .eq('client_id', clientId)
    .order('date', { ascending: false })
    .limit(50);
  
  // Store globally for PDF export
  currentViewClient = client;
  currentViewCycleData = cycleData;
  
  document.getElementById('viewClientName').textContent = client.name || client.code;
  
  const moodLabels = {joyeuse: 'üòä', triste: 'üò¢', irritable: 'üò°', anxieuse: 'üò∞', energique: '‚ö°', fatiguee: 'üò¥'};
  const mucusLabels = {absent: 'üåµ Absente', sticky: 'üß¥ Collante', creamy: 'ü•õ Cr√©meuse', eggwhite: 'ü•ö Blanc d\'≈ìuf', watery: 'üíß Aqueuse'};
  const libidoLabels = {1: 'Tr√®s faible', 2: 'Faible', 3: 'Moyen', 4: '√âlev√©', 5: 'Tr√®s √©lev√©'};
  const sleepQualityLabels = {1: 'üò´ Mauvaise', 2: 'üòî M√©diocre', 3: 'üòê Moyenne', 4: 'üôÇ Bonne', 5: 'üòä Excellente'};
  
  // Calculate insights
  const insights = calculateInsights(client, cycleData || []);
  
  const container = document.getElementById('clientDataContainer');
  container.innerHTML = `
    <div style="margin-bottom:20px;padding:16px;background:rgba(102,126,234,0.05);border-radius:12px;">
      <strong>Code:</strong> ${client.code}<br>
      <strong>Contraception:</strong> ${client.contraception || 'Aucune'}<br>
      ${client.contraception_start_date ? `<strong>Depuis le:</strong> ${new Date(client.contraception_start_date).toLocaleDateString('fr-FR')}<br>` : ''}
      <strong>Cr√©√©e le:</strong> ${new Date(client.created_at).toLocaleDateString('fr-FR')}
    </div>
    
    ${insights.length > 0 ? `
      <div style="margin-bottom:20px;">
        <div style="font-weight:700;font-size:16px;margin-bottom:12px;">üí° Insights d√©couverts</div>
        ${insights.map(insight => `
          <div style="padding:12px;background:white;border-radius:10px;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,0.04);">
            <div style="display:flex;align-items:flex-start;gap:10px;">
              <div style="font-size:24px;">${insight.icon}</div>
              <div>
                <div style="font-weight:600;margin-bottom:4px;">${insight.title}</div>
                <div style="font-size:13px;color:#666;">${insight.text}</div>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    ` : ''}
    
    <div style="margin-bottom:12px;"><strong>üìä Derni√®res entr√©es (${cycleData ? cycleData.length : 0}) :</strong></div>
    ${cycleData && cycleData.length > 0 ? cycleData.map(day => {
      let content = `<div style="padding:16px;background:white;border-radius:12px;margin-bottom:12px;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,0.06);">`;
      content += `<div style="font-weight:700;font-size:15px;margin-bottom:12px;color:#667eea;">${new Date(day.date).toLocaleDateString('fr-FR', {weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'})}</div>`;
      
      // Period
      if (day.period) {
        content += `<div style="margin-bottom:8px;">üî¥ <strong>R√®gles:</strong> ${day.period}</div>`;
      }
      
      // Spotting
      if (day.spotting) {
        content += `<div style="margin-bottom:8px;">üíú <strong>Spotting:</strong> Oui</div>`;
      }
      
      // Symptoms
      if (day.symptoms && day.symptoms.length > 0) {
        content += `<div style="margin-bottom:8px;">‚ö†Ô∏è <strong>Sympt√¥mes:</strong> ${day.symptoms.join(', ')}</div>`;
      }
      
      // Temperature
      if (day.temperature) {
        content += `<div style="margin-bottom:8px;">üå°Ô∏è <strong>Temp√©rature:</strong> ${day.temperature}¬∞C`;
        if (day.temp_factors && day.temp_factors.length > 0) {
          content += ` <span style="color:#999;">(Facteurs: ${day.temp_factors.join(', ')})</span>`;
        }
        content += `</div>`;
      }
      
      // Cervical mucus
      if (day.cervical_mucus) {
        content += `<div style="margin-bottom:8px;">${mucusLabels[day.cervical_mucus] || day.cervical_mucus}</div>`;
      }
      
      // Mood
      if (day.mood && day.mood.length > 0) {
        content += `<div style="margin-bottom:8px;">üòä <strong>Humeur:</strong> ${day.mood.map(m => moodLabels[m] || m).join(' ')} ${day.mood.join(', ')}</div>`;
      }
      
      // Weight
      if (day.weight) {
        content += `<div style="margin-bottom:8px;">‚öñÔ∏è <strong>Poids:</strong> ${day.weight} kg</div>`;
      }
      
      // Sleep
      if (day.sleep_hours) {
        content += `<div style="margin-bottom:8px;">üò¥ <strong>Sommeil:</strong> ${day.sleep_hours}h`;
        if (day.sleep_quality) {
          content += ` - ${sleepQualityLabels[day.sleep_quality] || day.sleep_quality}`;
        }
        content += `</div>`;
      }
      
      // Libido
      if (day.libido) {
        content += `<div style="margin-bottom:8px;">üíï <strong>Libido:</strong> ${libidoLabels[day.libido] || day.libido}</div>`;
      }
      
      // Notes
      if (day.notes) {
        content += `<div style="margin-top:12px;padding:12px;background:rgba(102,126,234,0.05);border-radius:8px;">
          <div style="font-weight:600;margin-bottom:6px;">üìù Notes:</div>
          <div style="line-height:1.5;">${day.notes}</div>
        </div>`;
      }
      
      content += `</div>`;
      return content;
    }).join('') : '<p style="color:#999;text-align:center;padding:40px;">Aucune donn√©e enregistr√©e</p>'}
  `;
  
  document.getElementById('viewClientModal').classList.add('show');
}

function closeViewClientModal() {
  document.getElementById('viewClientModal').classList.remove('show');
}

// INSIGHTS CALCULATION
function calculateInsights(client, cycleData) {
  if (!cycleData || cycleData.length < 14) return [];
  
  const insights = [];
  
  // Symptom patterns
  const symptoms = {};
  cycleData.forEach(day => {
    if (day.symptoms && day.symptoms.length > 0) {
      day.symptoms.forEach(s => {
        if (!symptoms[s]) symptoms[s] = 0;
        symptoms[s]++;
      });
    }
  });
  
  Object.keys(symptoms).forEach(symptom => {
    const count = symptoms[symptom];
    const percentage = Math.round((count / cycleData.length) * 100);
    if (percentage >= 30) {
      insights.push({
        icon: '‚ö†Ô∏è',
        title: `${symptom} fr√©quent`,
        text: `Pr√©sent dans ${percentage}% des jours enregistr√©s`
      });
    }
  });
  
  // Mood patterns
  const moods = {};
  cycleData.forEach(day => {
    if (day.mood && day.mood.length > 0) {
      day.mood.forEach(m => {
        if (!moods[m]) moods[m] = 0;
        moods[m]++;
      });
    }
  });
  
  const moodLabels = {joyeuse: 'üòä Joyeuse', triste: 'üò¢ Triste', irritable: 'üò° Irritable', anxieuse: 'üò∞ Anxieuse', energique: '‚ö° √ânergique', fatiguee: 'üò¥ Fatigu√©e'};
  Object.keys(moods).forEach(mood => {
    const count = moods[mood];
    const percentage = Math.round((count / cycleData.length) * 100);
    if (percentage >= 30) {
      insights.push({
        icon: moodLabels[mood] ? moodLabels[mood].split(' ')[0] : 'üòä',
        title: `Humeur ${mood}`,
        text: `Pr√©sente dans ${percentage}% des jours`
      });
    }
  });
  
  return insights;
}

// PDF EXPORT
async function exportClientPDF() {
  if (!currentViewClient || !currentViewCycleData) return;
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  const client = currentViewClient;
  const cycleData = currentViewCycleData;
  const insights = calculateInsights(client, cycleData);
  
  // Title
  doc.setFontSize(20);
  doc.setFont(undefined, 'bold');
  doc.text(`Rapport - ${client.name || client.code}`, 20, 20);
  
  // Client info
  doc.setFontSize(12);
  doc.setFont(undefined, 'normal');
  let y = 35;
  doc.text(`Code: ${client.code}`, 20, y);
  y += 7;
  if (client.contraception) {
    doc.text(`Contraception: ${client.contraception}`, 20, y);
    y += 7;
  }
  doc.text(`Date creation: ${new Date(client.created_at).toLocaleDateString('fr-FR')}`, 20, y);
  y += 10;
  
  // Insights
  if (insights.length > 0) {
    doc.setFont(undefined, 'bold');
    doc.text('Insights decouverts:', 20, y);
    y += 7;
    doc.setFont(undefined, 'normal');
    
    insights.slice(0, 5).forEach(insight => {
      if (y > 270) {
        doc.addPage();
        y = 20;
      }
      doc.text(`- ${insight.title}: ${insight.text}`, 25, y);
      y += 6;
    });
    y += 5;
  }
  
  // Cycle data
  doc.setFont(undefined, 'bold');
  if (y > 250) {
    doc.addPage();
    y = 20;
  }
  doc.text(`Dernieres entrees (${Math.min(cycleData.length, 20)}):`, 20, y);
  y += 7;
  doc.setFont(undefined, 'normal');
  doc.setFontSize(10);
  
  cycleData.slice(0, 20).forEach(day => {
    if (y > 270) {
      doc.addPage();
      y = 20;
    }
    
    const date = new Date(day.date).toLocaleDateString('fr-FR');
    doc.setFont(undefined, 'bold');
    doc.text(date, 20, y);
    doc.setFont(undefined, 'normal');
    y += 5;
    
    const items = [];
    if (day.period) items.push(`Regles: ${day.period}`);
    if (day.spotting) items.push('Spotting');
    if (day.symptoms && day.symptoms.length) items.push(`Symptomes: ${day.symptoms.join(', ')}`);
    if (day.temperature) items.push(`Temp: ${day.temperature}C`);
    if (day.cervical_mucus) items.push(`Glaire: ${day.cervical_mucus}`);
    if (day.weight) items.push(`Poids: ${day.weight}kg`);
    if (day.libido) items.push(`Libido: ${day.libido}/5`);
    if (day.notes) items.push(`Note: ${day.notes.substring(0, 50)}${day.notes.length > 50 ? '...' : ''}`);
    
    items.forEach(item => {
      if (y > 280) {
        doc.addPage();
        y = 20;
      }
      doc.text(item, 25, y);
      y += 4;
    });
    y += 3;
  });
  
  // Save PDF
  doc.save(`rapport-${client.code}-${new Date().toISOString().split('T')[0]}.pdf`);
}

function closeViewClientModal() {
  document.getElementById('viewClientModal').classList.remove('show');
}

// INIT
document.addEventListener('DOMContentLoaded', () => {
  if (localStorage.getItem('adminLoggedIn') === 'true') {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('adminApp').classList.add('active');
    loadDashboard();
  }
});

document.getElementById('adminPassword').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') adminLogin();
});
</script>

</body>
</html>
